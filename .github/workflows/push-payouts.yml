name: push-payouts

on:
  workflow_dispatch: {}
  push:
    paths:
      - "payouts.csv"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Upload payouts.csv
      - name: upload payouts.csv
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.FARPY_HOST }}
          username: root
          key:      ${{ secrets.FARPY_SSH_KEY }}
          source:   "payouts.csv"
          target:   "/opt/farpy/ops/"

      # Purge only the two ops URLs at Cloudflare
      - name: purge Cloudflare (ops URLs)
        env:
          CF_TOKEN: ${{ secrets.CF_TOKEN }}
          CF_ZONE:  ${{ secrets.CF_ZONE }}
        run: |
          curl -fsS -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE}/purge_cache" \
            -H "Authorization: Bearer ${CF_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://farpy.com/api/ops-log","https://farpy.com/api/payouts.csv"]}'

      # Log on the server
      - name: log deploy on ops log
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.FARPY_HOST }}
          username: root
          key:      ${{ secrets.FARPY_SSH_KEY }}
          script: |
            farpy-ops log "payouts updated via GH Actions: $GITHUB_SHA"
